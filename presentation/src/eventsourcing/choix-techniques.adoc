== Design de l'agr√©gat

[.notes]
--
Qui dit nouveau projet dit choix d'architecture, et surtout concernant la gestion de l'agr√©gat.

l√† on a plusieurs possibilit√©s, je vais n'en citer que deux heeuu parce que.

*click*
--

=== State sourcing

[.notes]
--
Le State sourcing, c'est la mani√®re de g√©rer nos agr√©gats comme on fait d'habitude.

Sans parler d'objets dits "an√©miques", on va quand m√™me, pour une requ√™te donn√©e,
mettre √† jour l'√©tat de l'agr√©gat, soit le muter, soit en faire une copie.

C'est-√†-dire qu'apr√®s un changement, on se retrouve avec la derni√®re version dans les mains.

Je vais prendre un exemple pour illustrer le truc

Imaginons vous avez...au hasard... des cartes cadeaux √† g√©rer
--

[%notitle]
=== example statefull

[cols="4*",options="header"]
|=============================================================
| barcode | shopping +
                      store | remaning +
                                        amount  |  exhausted()
| 1234    | Restaurant      | 90 ‚Ç¨              |    false
|=============================================================

[.notes]
--
Alors √ßa ressemble vachement √† une table sql mais on parle bien d'un agr√©gat ici.
M√™me si √ßa arrive souvent tel quel en base de donn√©es.

Bref quand je d√©clare ma carte cadeau, j'ai √ßa en mains,
il y a un code-barre "1234", une boutique "restaurant", un montant "90 ‚Ç¨" et une m√©thode qui nous dit si oui ou non la carte est vie.

Si je paye 30 ‚Ç¨ avec, j'obtiens √ßa
--

[%notitle]
=== example statefull

[cols="4*", options="header"]
|=============================================================
| barcode | shopping +
                      store | remaning +
                                        amount  |  exhausted()
| 1234    | Restaurant    | 60 ‚Ç¨                |    false
|=============================================================

[.notes]
--
Ma carte cadeau n'a plus que 60 ‚Ç¨.

Remarquez que je n'ai plus ici le montant initial.

Et si je d√©pense les 60 ‚Ç¨ restants
--

[%notitle]
=== example statefull

[cols="4*", options="header"]
|=============================================================
| barcode | shopping +
                      store | remaning +
                                        amount  |  exhausted()
| 1234    | Restaurant    | 0 ‚Ç¨                 |    true
|=============================================================

[.notes]
--
ma carte cadeaux est vide et donc inutilisable.

Mais le point ici c'est que le champ "montant" a √©t√© √©cras√©.

Ce qui veut dire qu'apr√®s un changement,
on a certes des valeurs √† jour, mais plus aucune trace de ce qu'elles ont √©t√©.

Comme je l'ai dit, √ßa, c'est le fonctionnement classique de nos app.
--

=== Avantages

[%step]
- Facile √† comprendre
- Facile √† lire
- On fait tout le temps comme √ßa

[.notes]
--
Regardons les avantages.

*click*

- C'est facile √† comprendre, on a un √©tat et on le modifie
- C'est facile √† lire, que ce soit en base ou en debug, on voit l'√©tat au premier coup d'≈ìil
- On fait tout le temps comme √ßa, c'est la mani√®re dont on a appris √† faire
--

=== Inconv√©nients


[%step]
- Perte d'information
- Pas de tra√ßabilit√©
- Obligation d'anticiper les besoins futurs

[.notes]
--
Par contre c√¥t√© inconv√©nients, on a en top #1 la perte d'information.

et les autres qui en d√©coulent, comme par exemple

pas de tra√ßabilit√©, on sait o√π on en est mais on n'a aucune id√©e de comment on y est arriv√©.

et on est oblig√© d'anticiper les besoins futurs,
si demain on veut savoir combien de fois j'ai utilis√© ma carte cadeau, c'est mort.
Il faut soit le pr√©voir d√®s le d√©but, soit s'asseoir sur les donn√©es.

--

=== Event sourcing

[.notes]
--
L'autre choix de gestion de l'agr√©gat, c'est l'event sourcing.

L√† c'est un changement de paradigme.

Plut√¥t que de stocker l'√©tat de l'agr√©gat, on va stocker les √©v√©nements qui ont modifi√© cet √©tat.

Le premier √©v√©nement est le d√©but de l'histoire de l'agr√©gat,
celui qui pose les bases, comme l'identifiant de l'agr√©gat.

Et on va stacker dans une liste la suite des autres √©v√©nements de l'histoire.

J'appelle √ßa l'histoire, mais vous pouvez trouver d'autres noms comme "stream".

Si je reprends mon exemple de carte cadeau,
--


[%notitle.moresmaller]
=== example event sourcing

[cols="4*", options="header"]
|================================================================================================
| type                   | barcode | sequenceId | payload
| GiftCardDeclared       | 1234    | 0          | shoppingStore: "Restaurant", +
                                                   initialAmount: "90 ‚Ç¨"
|================================================================================================


[.notes]
--
Lors de ma d√©claration de carte carte cadeau,
je cr√©e mon d√©but d'histoire avec l'√©v√©nement de type "GiftCardDeclared".

Cet √©v√©nement porte l'identifiant, pour nous c'est le code-barre

Il porte aussi une charge utile, pour nous, c'est le magasin et le montant initial
(les trucs qu'on a tap√© dans le formulaire de declaration)

Et si je dis √† mon syst√®me "je paye 30 ‚Ç¨ avec"
--

[%notitle.moresmaller]
=== example event sourcing

[cols="4*", options="header"]
|================================================================================================
| type                     | barcode | sequenceId | payload
| GiftCardDeclared         | 1234    | 0          | shoppingStore: "Restaurant", +
                                                     initialAmount: "90 ‚Ç¨"
| PaidAmount               | 1234    | 1          | amount: "30 ‚Ç¨", +
                                                     on: "2025-03-01"
|================================================================================================


[.notes]
--
boum, j'ai un nouvel √©v√©nement avec un type diff√©rent.

Remarquez que les √©v√©nements sont des choses qui se sont pass√©es, c'est pour √ßa qu'on √©crit leur type au pass√©

- la carte a √©t√© cr√©√©e
- un montant a √©t√© pay√©

Il porte lui aussi l'id de l'agr√©gat, le code-barre et il a pour charge utile le montant qui vient d'√™tre pay√©
et la date du paiement.

Et je n'ai pas parl√© de ce que j'ai appel√© sequenceId, c'est une information purement technique
mais qui a son importance, il permet de garantir l'ordre des √©v√©nements,
et donc d'√™tre s√ªr qu'on raconte l'histoire dans le bon ordre.

Le d√©but de l'histoire √©tant zero.

Avan√ßons et payons les 90 - 30 .. 60 ‚Ç¨ qu'il reste sur la carte
--

[%notitle.moresmaller]
=== example event sourcing

[cols="4*", options="header"]
|================================================================================================
| type                    | barcode | sequenceId | payload
| GiftCardDeclared        | 1234    | 0          | shoppingStore: "Restaurant", +
                                                    initialAmount: "90 ‚Ç¨"
| PaidAmount              | 1234    | 1          | amount: "30 ‚Ç¨", +
                                                    on: "2025-03-01"
| PaidAmount              | 1234    | 2          | amount: "60 ‚Ç¨", +
                                                    on: "2025-03-10"
| GiftCardExhausted       | 1234    | 3          | _null_
|================================================================================================
[.notes]
--
J'ai maintenant 2 nouveaux √©v√©nements,
un autre paidAmount avec son montant et sa date
et un √©v√©nement "GiftCardExhausted" qui n'a pas besoin de charge utile.

On pourrait se dire "il peut porter la date", mais dans notre cas un GiftCardExhausted ne vient pas tout seul
il vient avec un √©v√©nement PaidAmout.

En vrai c'est un choix qu'on a fait, on aurait pu se passer de l'√©v√©nement GiftCardExhausted
ou bien se passer du PaidAmount et faire porter √† l'GiftCardExhausted la date et le montant pay√©,
voire m√™me juste la date, vu que √ßa repr√©sente la carte vide, elle se retrouverait a 0 de toute mani√®re.

'fin il n'y a pas de recette miracle, l'essentiel c'est de faire des √©v√©nements qui nous parlent
et qui ont un sens m√©tier.

Voil√†, vous avez devant vous une histoire qui est racont√©e par les changements qui ont √©t√© appliqu√©s.
C'est un peu la d√©finition premi√®re de l'event sourcing.
--

=== Avantages

[%step]
- Pas de perte d'information
- Support super simple
- Resilient aux nouvelles fonctionnalit√©s

[.notes]
--
L'avantage num√©ro #1 *click* de cette approche est le fait qu'on ne perd pas d'information.

Tout changement est une nouvelle ligne dans l'histoire.

Le reste en d√©coule. *click* Vu qu'on a la liste des √©v√©nements, √ßa facilite le support.
"Qui n'a jamais r√™v√© de pouvoir dire apr√®s un rapide coup d'≈ìil √† la liste des √©v√©nements

> Si on est arriv√©s dans cet √©tat l√†, c'est parce qu'il s'est pass√© √ßa, puis √ßa, puis √ßa et
en fait on ne l'avait pas pr√©vu, on va fixer le probl√®me.

*click*

Pour finir derri√®re "r√©silient aux nouvelles fonctionnalit√©s", j'y mets plusieurs trucs :

- üëç Si le m√©tier vient nous voir en demandant des stats sur l'existant,
et bien vous pouvez leur fournir rapidement et ce, sur tout l'historique.
Comme par exemple le nombre de d√©pense par cartes, il suffit de compter les PaidAmount.
- ‚úåÔ∏è L'autre truc concerne le code, on ne l'a pas encore montr√©, √ßa arrive,
mais l'ajout d'une fonctionnalit√© se fait de mani√®re super simple :
une requ√™te arrive, on prend la d√©cision ou non de g√©n√©rer un √©v√©nement. point.
Pas de reprise de donn√©es, pas de nouvelle colonne √† mettre en base
--

[transition="slide-in fade-out"]
=== Inconv√©nients

[.same]
[%step]
- Beaucoup d'information
- Pas comme d'habitude
- Inutilisable en l'√©tat

[.notes]
--
c√¥t√© inconv√©nient,
*click*
il y a le fait qu'on explose le besoin de stockage.

l√† o√π on n'avait potentiellement qu'une ligne en base pour un √©tat simple,
on se retrouve avec une ligne pour chaque changement.

*click*

On n'a pas l'habitude de faire comme √ßa, et √ßa peut √™tre d√©routant au d√©but.
C'est un point s√©rieux √† prendre en compte, √ßa demande un temps d'adaptation aux √©quipes.

*click*

Et le pire c'est que vous n'avez pas d'√©tat exploitable tel quel,
vous avez des √©v√©nements,
c'est chouette mais on ne va pas montrer l'histoire compl√®te √† chaque utilisateur.

*click*
--

[transition="fade-in slide-out"]
=== Inconv√©nients

[.same]
- Beaucoup d'information
- Pas comme d'habitude
- Pas simple √† utiliser en l'√©tat

[.notes]
--
Heureusement l'event sourcing ce n'est pas que √ßa et on en parle plus loin.
--
