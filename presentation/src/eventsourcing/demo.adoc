== Code
üîç

Les √©v√©nements
[.notes]
--
En attendant, regardons √† quoi √ßa ressemble dans le code
--

=== Interface GiftCardEvent

[source, java, highlight]
----
include::../../../src/main/java/io/craft/giftcard/giftcard/domain/events/GiftCardEvent.java[lines='7..']
----

[.notes]
--
C√¥t√© √©v√©nements, pour les manipuler on va cr√©er une interface scell√©e sobrement appeler GiftCardEvent.

Elle contient des donn√©es qui pourraient √™tre consid√©r√©es comme "technique",
bouh c'est pas beau √ßa n'a rien √† faire dans le domaine.
Mais h√©, pas besoin d'√™tre dogmatique si √ßa permet de simplifier la comprehension du code.
--

=== GiftCardCreated

[source, java, highlight="..|3,5..6"]
----
include::../../../src/main/java/io/craft/giftcard/giftcard/domain/events/GiftCardCreated.java[lines='9..']
----

[.notes]
--
Dans les implem, on a le d√©but de notre histoire avec l'√©v√©nement GiftCardCreated.

*click*

Comme je l'ai dit pr√©c√©dement c'est le d√©but de l'histoire,
il porte l'id de l'agr√©gat et les donn√©es de bases.

ici le montant & le magasin
--

=== PaidAmount

[source, java, highlight='..|5..6']
----
include::../../../src/main/java/io/craft/giftcard/giftcard/domain/events/PaidAmount.java[lines='9..']
----

[.notes]
--
On en a 3 on va tous les faire, voici le PaidAmount

*click*

Vous vous en souvenez, il porte le montant pay√© et la date de paiement
--

=== GifCardExhausted

[.smaller]
[source, java, highlight='..']
----
include::../../../src/main/java/io/craft/giftcard/giftcard/domain/events/GifCardExhausted.java[lines='7,8']
----

[.notes]
--
Notre dernier √©v√©nement est GifCardExhausted qui se suffit √† lui m√™me.
--

=== Code
üîç

L'agr√©gat

[.notes]
--
Maintenant qu'on a vu les √©v√©nements, voyons comment on les utilise dans notre agregat.
--

=== `GiftCard.declare()`

[source, java, highlight]
----
include::../../../src/main/java/io/craft/giftcard/giftcard/domain/GiftCard.java[lines='14..16, 23']
    // ...
include::../../../src/main/java/io/craft/giftcard/giftcard/domain/GiftCard.java[lines='25..26']
include::../../../src/main/java/io/craft/giftcard/giftcard/domain/GiftCard.java[lines='27..35']
include::../../../src/main/java/io/craft/giftcard/giftcard/domain/GiftCard.java[tags='closingBrace']
----

[.notes]
--
Tout d'abord, on a la fonction statique declare qui va cr√©er notre carte cadeau.

Elle est statique car vu que GiftCardCreated est le d√©but de l'histoire,
on ne peut pas avoir une instance construite avant de d√©cider de commencer l'histoire ü§∑

Elle va retourner simplement notre √©v√©nement GiftCardCreated.
--

[transition="slide-in fade-out"]
=== `giftCard.pay()`

[source, java, highlight='..|11,12|9,10|15|..']
----
include::../../../src/main/java/io/craft/giftcard/giftcard/domain/GiftCard.java[lines='14..16, 23']
    // ...
include::../../../src/main/java/io/craft/giftcard/giftcard/domain/GiftCard.java[lines='25..26']
include::../../../src/main/java/io/craft/giftcard/giftcard/domain/GiftCard.java[lines='36, 41..46, 55..57']
include::../../../src/main/java/io/craft/giftcard/giftcard/domain/GiftCard.java[tags='closingBrace']
----

[.notes]
--
Un poil plus compliqu√©, on a la fonction pay qui va, dans un premier temps,
nous retourner un √©v√©nement PaidAmount

*click*

On fabrique l'ev√©nement avec notre charge utile venant du command object, le param√®tre

*click*

Remarquez que les informations "techniques" viennent directement de l'agr√©gat lui m√™me,
on ne fait pas que appeler des fonctions statiques, c'est pas un simple builder d'√©v√©nements.

*click*

on le retourne sous forme de liste, mais √ßa on va y revenir

*click*

ceci dit, je parle depuis le d√©but de "prise de d√©cision", voil√† ce que √ßa peut donner :
--

[transition="fade-in fade-out"]
=== `giftCard.pay()`

[source, java, highlight='8..10']
----

include::../../../src/main/java/io/craft/giftcard/giftcard/domain/GiftCard.java[lines='14..16, 23']
    // ...
include::../../../src/main/java/io/craft/giftcard/giftcard/domain/GiftCard.java[lines='25..26']
include::../../../src/main/java/io/craft/giftcard/giftcard/domain/GiftCard.java[lines='36..39, 41..46, 55..57']
include::../../../src/main/java/io/craft/giftcard/giftcard/domain/GiftCard.java[tags='closingBrace']
----

[.notes]
--
Si par exemple, notre carte cadeau n'est pas assez fournie, on ne cr√©e pas la commande.

Ici on lance une exception mais en on aurait pu encapsuler la r√©ponse dans un type Alg√©brique type `Either`
--

[transition="fade-in slide-out"]
=== `giftCard.pay()`

[source, java, highlight='14..19']
----

include::../../../src/main/java/io/craft/giftcard/giftcard/domain/GiftCard.java[lines='14..16, 23']
    // ...
include::../../../src/main/java/io/craft/giftcard/giftcard/domain/GiftCard.java[lines='25..26']
include::../../../src/main/java/io/craft/giftcard/giftcard/domain/GiftCard.java[lines='36..39, 41,46, 48..57']
include::../../../src/main/java/io/craft/giftcard/giftcard/domain/GiftCard.java[tags='closingBrace']
----

[.notes]
--
Et mieux, si avec cette commande on sait qu'on va vider la carte (avec le `this.hasExactBalance(payment.amount())`)
on rajoute un √©v√©n√©ment en sortie, le fameux GiftCardExhausted
--


=== Code
üîç

L'application service

[.notes]
--
On a vu les √©vents, on a vu leur g√©n√©ration.
C'est joli, mais on a fait un agr√©gat sans aucun effet de bord.

Maintenant voyons comment on interface notre agr√©gat avec le reste du monde
grace √† notre application service
--

=== `GiftCardApplicationService.declare()`

[source, java, highlight='..|10|11|12']
----
include::../../../src/main/java/io/craft/giftcard/giftcard/application/GiftCardApplicationService.java[lines='20..23,25,26,40..42,48..52']
include::../../../src/main/java/io/craft/giftcard/giftcard/application/GiftCardApplicationService.java[tags='closingBrace']
----

[.notes]
--
voil√†, pour la d√©claration c'est aussi simple que √ßa.

*click*

On appelle l'agr√©gat pour nous fournir l'√©v√©nement,

*click*

on le sauvegarde

*click*

et on le propage.
--

=== `GiftCardApplicationService.pay()`

[source, java, highlight='..|9|10..12|..']
----
include::../../../src/main/java/io/craft/giftcard/giftcard/application/GiftCardApplicationService.java[lines='20..23,25,26,53..60']
include::../../../src/main/java/io/craft/giftcard/giftcard/application/GiftCardApplicationService.java[tags='closingBrace']
----

[.notes]
--
C√¥t√© paiement, c'est tout aussi simple,

*click*

√† la diff√©rence pr√®s qu'on a besoin de fabriquer notre GiftCard depuis son historique.
Qu'on r√©cup√®re directement depuis l'event store.

*click*

et rebelotte, on demande √† l'agr√©gat de nous fournir des √©v√©nements pour cette commande, on les sauvegarde et on les propage.

*click*

Pourquoi les propager me direz-vous ?

Pour r√©pondre √† √ßa, j'ai une question pour vous:

Sachant que jusqu'ici, on a manipul√© uniquement des √©v√©nements,

Comment est-ce qu'on affiche la liste des cartes  cadeaux ?

ce dispatcher va nous y aider mais je laisse √† Aur√©lien le soin de vous expliquer d'o√π √ßa vient.
--
