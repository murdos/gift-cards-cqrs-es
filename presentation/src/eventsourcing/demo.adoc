== Code
üîç

-> Les √©v√©nements

L'agr√©gat

L'application service
[.notes]
--
Pour √ßa, on va se promener dans le code

En commen√ßant par voir √† quoi ressemble un √©v√©nement,
comment il est produit dans l'agr√©gat.

Et comment √ßa s'articule dans un service classique.
--

=== Interface `GiftCardEvent`

[source, java, highlight]
----
include::../../../src/main/java/io/craft/giftcard/giftcard/domain/events/GiftCardEvent.java[lines='8..15']
----

[.notes]
--
C√¥t√© √©v√©nements, pour les manipuler on va cr√©er une interface scell√©e sobrement appeler GiftCardEvent.

Elle force l'impl√©mentation les donn√©es communes comme le codebarre, qui est l'identifiant de notre agr√©gat,
et le s√©quence Id, le truc dont j'ai parl√© tout √† l'heure qui force l'histoire dans le bon sens.

On pourrait y rajouter un auteur, une date de cr√©ation‚Ä¶
--

=== `GiftCardDeclared`

[source, java, highlight="..|3,5..6"]
----
include::../../../src/main/java/io/craft/giftcard/giftcard/domain/events/GiftCardDeclared.java[lines='9..']
----

[.notes]
--
Dans les implem, on a le d√©but de notre histoire avec l'√©v√©nement `GiftCardDeclared`.

*click*

Comme je l'ai dit pr√©c√©dement c'est le d√©but de l'histoire,
il porte l'id de l'agr√©gat et les donn√©es de bases.

ici le montant & le magasin
--

=== `PaidAmount`

[source, java, highlight='..|5..6']
----
include::../../../src/main/java/io/craft/giftcard/giftcard/domain/events/PaidAmount.java[lines='10..17']
----

[.notes]
--
On a 3 √©v√©nements, on va tous les faire √ßa va √™tre rapide, voici le `PaidAmount`

*click*

Vous vous en souvenez, il porte le montant pay√© et la date de paiement
--

=== `GifCardExhausted`

[.smaller]
[source, java, highlight='..']
----
include::../../../src/main/java/io/craft/giftcard/giftcard/domain/events/GifCardExhausted.java[lines='7,8']
----

[.notes]
--
Pour finir, le dernier √©v√©nement est `GifCardExhausted` qui se suffit √† lui m√™me.
--

=== Code
üîç

Les √©v√©nements

-> L'agr√©gat

L'application service

[.notes]
--
Maintenant qu'on a vu les √©v√©nements, voyons comment on les g√©n√®re depuis notre agr√©gat,
le coeur de notre m√©tier.

Il s'appelle d'ailleurs GiftCard
--

=== `GiftCard.declare()`

[source, java, highlight='..|8|9..14']
----
include::../../../src/main/java/io/craft/giftcard/giftcard/domain/GiftCard.java[lines='10..12,19']
    // ...
include::../../../src/main/java/io/craft/giftcard/giftcard/domain/GiftCard.java[lines='21..22']
include::../../../src/main/java/io/craft/giftcard/giftcard/domain/GiftCard.java[lines='23..30']
include::../../../src/main/java/io/craft/giftcard/giftcard/domain/GiftCard.java[tags='closingBrace']
----

[.notes]
--
Tout d'abord, on a la static factory `declare` qui va cr√©er notre carte cadeau.

Elle est statique car on a vu que l'√©v√©nement GiftCardDeclared √©tait le d√©but de l'histoire.
Si on n'a pas le d√©but de l'histoire, comment est-ce qu'on aurait une instance de quoi que ce soit ? ü§∑

*click*

Elle prend en param√®tre un GiftCardDeclaration qui est le command object, c'est le d√©tail de ma commande

*click*

Elle va retourner simplement notre √©v√©nement GiftCardDeclared.
--

[transition="slide-in fade-out"]
=== `giftCard.pay()`

[source, java, highlight='..|12,13|10,11|16|..']
----
include::../../../src/main/java/io/craft/giftcard/giftcard/domain/GiftCard.java[lines='10..12,19']
    // ...
include::../../../src/main/java/io/craft/giftcard/giftcard/domain/GiftCard.java[lines='21..22']
include::../../../src/main/java/io/craft/giftcard/giftcard/domain/GiftCard.java[lines='32, 37..42, 51..53']
include::../../../src/main/java/io/craft/giftcard/giftcard/domain/GiftCard.java[tags='closingBrace']
----

[.notes]
--
Un poil plus compliqu√©, on a la fonction pay qui va, dans un premier temps,
nous retourner un √©v√©nement PaidAmount

*click*

On fabrique l'ev√©nement avec notre charge utile venant du command object, le param√®tre

*click*

Remarquez que les informations "techniques" viennent directement de l'instance de l'agr√©gat lui m√™me.

*click*

on le retourne sous forme de liste.

*click*

*Aur√©lien >* Psourquoi une liste ?
--

[transition="fade-in slide-out"]
=== `giftCard.pay()`

[source, java, highlight='13..18']
----

include::../../../src/main/java/io/craft/giftcard/giftcard/domain/GiftCard.java[lines='10..12,19']
    // ...
include::../../../src/main/java/io/craft/giftcard/giftcard/domain/GiftCard.java[lines='21..22']
include::../../../src/main/java/io/craft/giftcard/giftcard/domain/GiftCard.java[lines='32,37']
      // ...
include::../../../src/main/java/io/craft/giftcard/giftcard/domain/GiftCard.java[lines='42, 44..53']
include::../../../src/main/java/io/craft/giftcard/giftcard/domain/GiftCard.java[tags='closingBrace']
----

[.notes]
--
Parce que si la carte est vide, on a dit qu'on retournait aussi l'√©v√©nement GifCardExhausted.
--


=== Code
üîç

Les √©v√©nements

L'agr√©gat

-> L'application service

[.notes]
--
On a vu les √©vents, on a vu leur g√©n√©ration.
C'est joli, mais on a fait un agr√©gat sans aucun effet de bord.
(Pour info √ßa s'appelle du Functional core)

Maintenant voyons comment on interface notre agr√©gat avec le reste du monde
grace √† notre application service qui est notre point d‚Äôentr√©e qui sera appel√© par les contr√¥leurs
--

=== `GiftCardApplicationService.declare()`

[source, java, highlight='..|9|10|11']
----
include::../../../src/main/java/io/craft/giftcard/giftcard/application/GiftCardApplicationService.java[lines='24..25,27,30,47..49,55..59']
include::../../../src/main/java/io/craft/giftcard/giftcard/application/GiftCardApplicationService.java[tags='closingBrace']
----

[.notes]
--
voil√†, pour la d√©claration c'est aussi simple que √ßa.

*click*

On appelle l'agr√©gat pour nous fournir l'√©v√©nement d'init,

*click*

on le sauvegarde

*click*

et on le propage.
--

=== `GiftCardApplicationService.pay()`

[source, java, highlight='..|8|9..11|..']
----
include::../../../src/main/java/io/craft/giftcard/giftcard/application/GiftCardApplicationService.java[lines='24..25,27,30,60..67']
include::../../../src/main/java/io/craft/giftcard/giftcard/application/GiftCardApplicationService.java[tags='closingBrace']
----

[.notes]
--
C√¥t√© paiement, c'est tout aussi simple,

*click*

√† la diff√©rence pr√®s qu'on va agir sur une instance de GiftCard qu'on fabrique depuis son historique.
Qu'on r√©cup√®re directement depuis l'event store.

*click*

et rebelotte, on demande √† l'agr√©gat de nous fournir des √©v√©nements pour cette commande, on les sauvegarde et on les propage.

*click*

Pourquoi les propager ?

Pour r√©pondre √† √ßa, j'ai une question pour vous:

Sachant que jusqu'ici, on a manipul√© uniquement des √©v√©nements,

Comment est-ce qu'on affiche la liste des cartes *click* cadeaux ?
--
