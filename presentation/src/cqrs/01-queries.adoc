== Comment afficher la liste des cartes cadeaux ?

[%step]
- Pagin√©e ü§î
- Tri√©e üòÆ
- Filtr√©e üò±

[.notes]
--
- Effectivement comment on fait pour afficher la liste avec quelques infos comme la boutique, le solde, ... ?
- Alors que ce qu'on a stock√© ce sont des √©v√®nements, dont on a vu que les informations utiles sont dans un payload.
- Relire tous les √©v√®nements pour reconstituer toutes les cartes cadeaux √† chaque fois para√Æt compliqu√©...
- *click* Et si en plus la liste doit √™tre pagin√©e pour n'afficher que 10 cartes cadeaux √† la fois
- *click* ou tri√©e, par exemple par le solde de la carte
- *click* ou encore filtr√©e par boutique...
- On pourrait se dire que c'est impossible, et que l'Event Sourcing n'est finalement pas tant que √ßa une Silver Bullet. Et bien c'est l√† que CQRS va nous √™tre tr√®s utile.
--

=== Une projection !

image::projection.png[]

[.notes]
--
- En effet, pour r√©soudre ce probl√®me, on va utiliser une projection, √©galement appel√©e "query model", "read model" ou "mod√®le de lecture". Par la suite, il est fort probable que j'utilise indiff√©remment ces termes.
- Cette projection va √™tre fabriqu√©e sur mesure par rapport √† notre besoin d'affichage, √† partir des √©v√®nements m√©tier.
- Alors, dans ce cas pr√©cis, ce mod√®le va √™tre tr√®s similaire au mod√®le qu'on aurait eu en state-sourcing, et c'est normal car on a finalement le m√™me besoin d'affichage.
- Mais la grosse diff√©rence, c'est que la projection n'est qu'une information d√©riv√©e, qui peut √™tre recalcul√©e √† tout moment √† partir de nos √©v√®nements. Et qui √©voluera et sera recalcul√©e lorsqu'on voudra afficher plus d'informations.
- D'ailleurs dans notre application, les projections ne sont pas persist√©es dans une base de donn√©es : elles sont juste en m√©moire, et recalcul√©es √† chaque red√©marrage de l'application. C'est tr√®s pratique en d√©but de projet, cela offre une grande souplesse.
--

[%notitle]
[transition="slide-in fade-out"]
=== Illustration : 0st event

image::fold00.png[]

[.notes]
--
- Voyons ce que cela donne si on d√©roule notre histoire pas √† pas.
- Tant qu'aucun √©v√®nement n'a √©t√© appliqu√©, √©videmment on n'a pas de projection.
--

[%notitle]
[transition="fade"]
=== Illustration : 1st event

image::fold01.png[]

[.notes]
--
- A partir de notre premier √©v√®nement, la d√©claration d'une carte, on va initialiser la projection avec :
- le code-barre,
- la boutique.
- Le solde qui sera √©gal au montant initial.
- Et le bool√©en qui indique que la carte n'est pas √©puis√©e.
--

[%notitle]
[transition="fade"]
=== Illustration : 2nd event

image::fold02.png[]

[.notes]
--
Ensuite lors d'un paiement, on va mettre √† jour le montant restant de la carte cadeau, en d√©duisant le montant du paiement.
--

[%notitle]
[transition="fade"]
=== Illustration : 3rd event

image::fold03.png[]

[.notes]
--
Sur le paiement suivant, on applique la m√™me logique
--

[%notitle]
[transition="fade-in slide-out"]
=== Illustration : 4rd event

image::fold04.png[]

[.notes]
--
- Enfin puisque la carte est √©puis√©e, on va mettre √† jour l'indicateur "exhausted" de la projection.
- Ce qui permettra de l'afficher de mani√®re distincte.
--

=== Code
üîç

[.notes]
--
- Regardons concr√®tement ce que cela donne c√¥t√© code
--

=== Query Model

[source, java, highlight]
----
include::../../../src/main/java/io/craft/giftcard/giftcard/domain/projections/currentstate/GiftCardCurrentState.java[lines='12..18']
----

[.notes]
--
- la projection s'appelle GiftCardCurrentState
- Il contient les informations strictement utiles pour l'affichage
- Comment ce mod√®le est-il calcul√© ? Vous vous souvenez de ce que C√©dric disait pr√©c√©demment, que les events √©taient propag√©s ?
--

=== Event publisher

[source, java, highlight="..|9..10"]
----
include::../../../src/main/java/io/craft/giftcard/giftcard/application/GiftCardApplicationService.java[lines='24..26,32..34,36..37,42..44,46']
----

[.notes]
--
- Et bien au niveau de l'EventPublisher, *click* des events handlers vont venir s'enregistrer pour √™tre abonn√©s aux √©v√®nements.
--

[transition="slide-in zoom-out"]
=== Event handler

[source, java, highlight='..|5..9|11|7..8|7']
----
include::../../../src/main/java/io/craft/giftcard/giftcard/domain/projections/currentstate/GiftCardCurrentStateUpdater.java[lines='8..9,17..26']
----

[.notes]
--
- L'event handler va √™tre appel√© √† chaque fois qu'un √©v√©nement est √©mis,
- *click*
- et va pouvoir alors recalculer la projection
- *click*
- puis la sauvegarder.
- *click*
- Pour d√©terminer la nouvelle projection, on va distinguer deux types d'events : le premier, et les suivants
--

[transition="zoom-in slide-out", transition-speed="slow"]
=== `GiftCardCurrentState.from()`

[source, java, highlight="4..|5..10"]
----
@QueryModel
public record GiftCardCurrentState(...) {

include::../../../src/main/java/io/craft/giftcard/giftcard/domain/projections/currentstate/GiftCardCurrentState.java[lines='19..27']
----

[.notes]
--
- C'est √† partir du 1er √©v√®nement de l'histoire, `GiftCardDeclared`, qu'on initialise la projection
- *click*
- En utilisant une static factory
- *click* *click* *click*
--

[transition="slide-in zoom-out", transition-speed="slow"]
=== `GiftCardCurrentStateUpdater.updateState()`

[source, java, highlight="3..|4..6|7"]
----
include::../../../src/main/java/io/craft/giftcard/giftcard/domain/projections/currentstate/GiftCardCurrentStateUpdater.java[lines='8..9,28..33']
----

[.notes]
--
- Et pour chacun des √©v√®nements suivants, on va mettre √† jour le mod√®le de lecture.
- *click*
- Pour cela on charge l'√©tat courant du mod√®le,
- *click*
- Et on lui applique chaque event
--

[transition="zoom-in slide-out", transition-speed="slow"]
=== `GiftCardCurrentState.apply()`

[source, java, highlight="4..|5,13|6..8|9"]
----
include::../../../src/main/java/io/craft/giftcard/giftcard/domain/projections/currentstate/GiftCardCurrentState.java[lines='12..13,35..47']
----

[.notes]
--
- on va faire du pattern matching pour traiter de mani√®re exhaustive tous les types d'√©v√©nements
- *click*
- paiement
- *click*
- ou carte √©puis√©e
--
