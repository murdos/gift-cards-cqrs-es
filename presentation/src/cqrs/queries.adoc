== Comment afficher la liste des cartes cadeaux ?

[.same]
- Pagin√©e ü§î

[.notes]
--
Les √©v√©nements c'est super pour avoir l'historique complet et savoir pr√©cis√©ment ce qui s'est pass√©, mais comment je fais pour afficher une liste de toutes mes cartes cadeaux avec quelques infos, comme le montant restant et la boutique de la carte ?
Relire tous les √©v√®nements de toutes les cartes cadeaux √† chaque fois para√Æt compliqu√©...
Et si en plus la liste doit √™tre pagin√©e pour n'afficher que 10 cartes cadeaux √† la fois
 *click*
--

[transition="fade"]
=== Comment afficher la liste des cartes cadeaux ?

[.same]
- Pagin√©e ü§î
- Tri√©e üòÆ

[.notes]
--
ou tri√©e selon un des attributs de la carte cadeau, par exemple le montant restant
*click*
--

[transition="fade"]
=== Comment afficher la liste des cartes cadeaux ?

[.same]
- Pagin√©e ü§î
- Tri√©e üòÆ
- Filtr√©e üò±

[.notes]
--
Voir m√™me filtr√©e selon un des attributs de la carte cadeau, par exemple la boutique
--

=== Query model !

image::jamy.jpg[height=350px]

=== Query model

image::https://spatie.be/docs/laravel-event-sourcing/v7/images/transform-03.svg[]

[.notes]
--
TODO: refaire le sch√©ma
- On va utiliser un query model, √©galement appel√© "read model ou "mod√®le de lecture".
- Ce mod√®le va √™tre fabriqu√© sur mesure par rapport √† notre besoin en lecture, √† partir des √©v√®nements m√©tier.
--

[%notitle]
=== Illustration : 1st event
image::https://codeopinion.com/wp-content/uploads/2021/02/s2-1024x466.png[]

[.notes]
--
TODO: refaire le sch√©ma
GiftCardCreated
-> GiftCardCurrentState
--

[%notitle]
=== Illustration : 2nd event
image::https://codeopinion.com/wp-content/uploads/2021/02/s2-1024x466.png[]

[.notes]
--
TODO: refaire le sch√©ma
GiftCardCreated
+ PaidAmount
-> GiftCardCurrentState
--

[%notitle]
=== Illustration : 3rd event
image::https://codeopinion.com/wp-content/uploads/2021/02/s2-1024x466.png[]

[.notes]
--
TODO: refaire le sch√©ma
GiftCardCreated
+ PaidAmount
+ PaidAmount
-> GiftCardCurrentState
--

[.notes]
--
On utilise un mod√®le de lecture d√©di√©
Egalement appel√© "read model ou ""query model"
--

=== Code
üîç

=== Query Model

[source, java, highlight]
----
include::../../../src/main/java/io/craft/giftcard/giftcard/domain/projections/GiftCardCurrentState.java[lines='12..18']
----

[.notes]
--
- C√¥te code, le mod√®le de lecture s'appelle GiftCardCurrentState
- Il contient les informations utilis√©es pour afficher dans la liste des cartes cadeaux, ou sur lesquelles on souhaiterait filtrer.
- Comment ce mod√®le est-il calcul√© ? Par un event handler.
--

=== Event handler

[source, java, highlight='..|7..8']
----
include::../../../src/main/java/io/craft/giftcard/giftcard/domain/projections/GiftCardCurrentStateUpdater.java[lines='8..9,17..26']
----

[.notes]
--
- L'event handler va √™tre appel√© √† chaque fois qu'un √©v√©nement est √©mis, et va pouvoir mettre √† jour le mod√®le de lecture
- *click*
- On va distinguer deux types d'events : le premier, et les suivants
--

[%notitle]
=== Event handler: init

[source, java, highlight="3|4"]
----
include::../../../src/main/java/io/craft/giftcard/giftcard/domain/projections/GiftCardCurrentStateUpdater.java[lines='8..9,28..30']
----

[source, java, highlight="3.."]
----
include::../../../src/main/java/io/craft/giftcard/giftcard/domain/projections/GiftCardCurrentState.java[lines='12..13,19..25']
----

[.notes]
--
- C'est √† partir du 1er √©v√®nement de l'histoire, `GiftCardCreated`, qu'on initialise le mod√®le de lecture
- *click*
- On va cr√©er une nouvelle instance de `GiftCardCurrentState` avec les donn√©es de l'√©v√®nement
--

[%notitle]
=== Event handler: update

[source, java, highlight="3..|4..6|7"]
----
include::../../../src/main/java/io/craft/giftcard/giftcard/domain/projections/GiftCardCurrentStateUpdater.java[lines='8..9,32..37']
----

[source, java, highlight="4,12|5..7|8"]
----
include::../../../src/main/java/io/craft/giftcard/giftcard/domain/projections/GiftCardCurrentState.java[lines='12..13,36..46']
----

[.notes]
--
- Et pour chacun des √©v√®nements suivants, on va, si n√©cessaire, mettre √† jour le mod√®le de lecture.
- *click*
- Pour cela on charge l'√©tat courant du mod√®le,
- *click*
- auquel on applique le nouvel √©v√©nement.
- *click*
- on fait du pattern matching pour traiter de mani√®re exhaustive tous les types d'√©v√©nements
--

=== Enregistrement des event handlers

[source, java, highlight="10..11"]
----
include::../../../src/main/java/io/craft/giftcard/giftcard/application/GiftCardApplicationService.java[lines='21..23,28..32,36..39']
----

[.notes]
--
- Les events handlers s'abonnent aux nouveaux √©v√®nements via l'EventPublisher, au niveau de l'application service
--
