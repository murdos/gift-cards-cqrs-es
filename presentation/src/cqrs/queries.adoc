== Afficher la liste des cartes cadeaux

Tri√©e, pagin√©e, filtr√©e, ... ü§î
[.notes]
--
Les √©v√©nements c'est super pour avoir l'historique complet et savoir pr√©cis√©ment ce qui s'est pass√©, mais comment je fais pour afficher une liste de toutes mes cartes cadeaux avec quelques infos, comme le montant restant et la boutique de la carte ?
Relire tous les √©v√®nements de toutes les cartes cadeaux √† chaque fois para√Æt compliqu√©...
Et si en plus on doit pagine, filtrer sur des crit√®res, comme par exemple le montant restant, trier selon d'autres crit√®res, ...
il nous faut les projeter.
--

=== Read/Query model!

image::../../assets/jamy.jpg[]
image::https://spatie.be/docs/laravel-event-sourcing/v7/images/transform-03.svg[]

[.notes]
--
TODO: refaire le sch√©ma
On va utiliser un mod√®le de lecture, √©galement appel√© "read model ou ""query model", d√©di√© √† notre use case.
--

[%notitle]
=== Illustration : 1st event
image::https://codeopinion.com/wp-content/uploads/2021/02/s2-1024x466.png[]

[.notes]
--
TODO: refaire le sch√©ma
GiftCardCreated
-> GiftCardCurrentState
--

[%notitle]
=== Illustration : 2nd event
image::https://codeopinion.com/wp-content/uploads/2021/02/s2-1024x466.png[]

[.notes]
--
TODO: refaire le sch√©ma
GiftCardCreated
+ PaidAmount
-> GiftCardCurrentState
--

[%notitle]
=== Illustration : 3rd event
image::https://codeopinion.com/wp-content/uploads/2021/02/s2-1024x466.png[]

[.notes]
--
TODO: refaire le sch√©ma
GiftCardCreated
+ PaidAmount
+ PaidAmount
-> GiftCardCurrentState
--

[.notes]
--
On utilise un mod√®le de lecture d√©di√©
Egalement appel√© "read model ou ""query model"
--

=== Code
üîç

=== Query Model

[source, java, highlight]
----
include::../../../src/main/java/io/craft/giftcard/giftcard/domain/projections/GiftCardCurrentState.java[lines='12..18']
----

[.notes]
--
- C√¥te code, le mod√®le de lecture s'appelle GiftCardCurrentState
- Comment est-il calcul√© ? (event handler)
--

=== Event handler

[source, java, highlight='..|7..8']
----
include::../../../src/main/java/io/craft/giftcard/giftcard/domain/projections/GiftCardCurrentStateUpdater.java[lines='8..9,17..26']
----

[.notes]
--
- L'event handler va √™tre appel√© √† chaque fois qu'un √©v√©nement est √©mis, et va pouvoir mettre √† jour le mod√®le de lecture
--

[%notitle]
=== Event handler: init

[source, java, highlight="4"]
----
include::../../../src/main/java/io/craft/giftcard/giftcard/domain/projections/GiftCardCurrentStateUpdater.java[lines='8..9,28..30']
----

[source, java, highlight="3.."]
----
include::../../../src/main/java/io/craft/giftcard/giftcard/domain/projections/GiftCardCurrentState.java[lines='12..13,19..25']
----

[.notes]
--
- A partir de l'event initial, GiftCardCreated, on initialise le mod√®le de lecture
--

[%notitle]
=== Event handler: update

[source, java, highlight="3..|4..6|7"]
----
include::../../../src/main/java/io/craft/giftcard/giftcard/domain/projections/GiftCardCurrentStateUpdater.java[lines='8..9,32..37']
----

[source, java, highlight="4,12|5..7|8"]
----
include::../../../src/main/java/io/craft/giftcard/giftcard/domain/projections/GiftCardCurrentState.java[lines='12..13,36..46']
----

[.notes]
--
- Et pour chacun des √©v√®nements suivants, on va, si besoin, mettre √† jour le mod√®le de lecture.
- Pour cela on charge l'√©tat courant du mod√®le, auquel on applique le nouvel √©v√©nement.
--
